"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});const knexfile_1=__importDefault(require("../../knexfile")),knex_1=__importDefault(require("knex")),lodash_1=require("lodash"),cartUtils_1=require("../controllers/cartUtils"),inventoryData=readData("inventory");exports.default={manualData:manualData,cartData:cartData,inventoryData:inventoryData,allData:allData};const knex=(0,knex_1.default)(knexfile_1.default),replacer=void 0,spacer=" ";function readData(route){let mainTable;return"cart"===route&&(mainTable="cart"),"inventory"===route&&(mainTable="inventory"),function(request,response){return __awaiter(this,void 0,void 0,(function*(){try{const data=yield knex.table(mainTable).select();let result=Object.assign({},data[0]);const itemsTable=result.itemsTable,items=yield knex.select().from(itemsTable).leftJoin("item",`${itemsTable}.itemID`,"item.id");result=Object.assign(Object.assign({},result),{items:items}),response.status(200).send(result)}catch(error){response.status(400).send(error)}}))}}function cartData(request,response){return __awaiter(this,void 0,void 0,(function*(){try{const{email:email,token:token}=request.body.user,cart=yield(0,cartUtils_1.getCartByToken)(email,token);response.status(200).send(cart)}catch(error){response.status(400).send(error)}}))}function manualData(request,response){return __awaiter(this,void 0,void 0,(function*(){try{const{table:table}=request.body,data=yield knex.table(table).select();response.status(200).send(data)}catch(error){response.status(400).send(error.message)}}))}function allData(request,response){return __awaiter(this,void 0,void 0,(function*(){if((0,lodash_1.isEmpty)(request.body))try{const item=yield knex.select().from("item"),inventory=yield knex.select().from("inventory"),inventoryItems=yield knex.select().from("inventoryItems"),cart=yield knex.select().from("cart"),cartItems=yield knex.select().from("cartItems"),data=JSON.stringify({item:item,inventory:inventory,inventoryItems:inventoryItems,cart:cart,cartItems:cartItems},replacer,spacer);response.type("text"),response.status(200).send(data)}catch(error){response.status(400).send(error)}else manualData(request,response)}))}function getKnex(config,knex){switch(config.mode){case"development":return knex(config.development);case"production":return knex(config.remote)}}