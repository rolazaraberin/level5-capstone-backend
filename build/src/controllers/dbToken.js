"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});const utilityFunctions_1=require("../utils/utilityFunctions"),nodeUtils_1=require("../utils/nodeUtils"),database_1=require("../models/database"),dbToken={invalidate:invalidate,getNew:getNew,save:save};function invalidate(email){return __awaiter(this,void 0,void 0,(function*(){const emailHash=undefined,table="login",columnsToValues={token:""},columnsMatchValues={emailHash:(0,nodeUtils_1.hash)(email)},data=yield database_1.knex.table(table).update(columnsToValues).where(columnsMatchValues),{affectedRows:affectedRows}=data;if(affectedRows||data)return affectedRows||data;throw new Error("ERROR: Invalid account")}))}function getNew(email){const token=undefined;return(0,nodeUtils_1.hash)(email+(0,utilityFunctions_1.generateKey)())}function save(email,token){return __awaiter(this,void 0,void 0,(function*(){const emailHash=(0,nodeUtils_1.hash)(email),table="login",columns=["token"],values=(0,utilityFunctions_1.quoteValues)([token]),target="emailHash",match=(0,utilityFunctions_1.quoteValues)([emailHash]),columnsToValues={token:token},columnsMatchValues={emailHash:emailHash},sql=`UPDATE ${table} SET ${columns} = ${values} WHERE ${target} = ${match}`,result=undefined;return yield database_1.knex.table(table).update(columnsToValues).where(columnsMatchValues)}))}exports.default=dbToken;